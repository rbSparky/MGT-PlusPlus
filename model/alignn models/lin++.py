# results on QMOF subset:
# Epoch loss: 30.8111
# Training time: 36.55417609214783 seconds
# /home/rishabh/miniconda3/envs/mgt_py310/lib/python3.10/site-packages/pymatgen/core/structure.py:3090: UserWarning: Issues encountered while parsing CIF: 2 fractional coordinates rounded to ideal values to avoid issues with finite precision.
#   struct = parser.parse_structures(primitive=primitive)[0]
# Validation error: 4.9170
# Validation time: 2.6333155632019043 seconds
# Completed Epoch 1 of 100 in 39.19 s
# /home/rishabh/miniconda3/envs/mgt_py310/lib/python3.10/site-packages/torch/distributed/fsdp/_state_dict_utils.py:768: UserWarning: When using ``NO_SHARD`` for ``ShardingStrategy``, full_state_dict willbe returned.
#   warnings.warn(
# /home/rishabh/miniconda3/envs/mgt_py310/lib/python3.10/site-packages/torch/distributed/fsdp/_state_dict_utils.py:711: UserWarning: When using ``NO_SHARD`` for ``ShardingStrategy``, full_state_dict willbe returned.
#   warnings.warn(
# Epoch loss: 5.2331
# Training time: 37.094844579696655 seconds
# Validation error: 0.4267
# Validation time: 3.104658365249634 seconds
# Completed Epoch 2 of 100 in 40.20 s
# Epoch loss: 21.3812
# Training time: 35.20649075508118 seconds
# Validation error: 2.7969
# Validation time: 3.0018482208251953 seconds
# Completed Epoch 3 of 100 in 38.21 s
# Epoch loss: 13.8811
# Training time: 27.205613136291504 seconds
# Validation error: 1.8507
# Validation time: 3.0961952209472656 seconds
# Completed Epoch 4 of 100 in 30.30 s
# Epoch loss: 2.0221
# Training time: 28.691335439682007 seconds
# Validation error: 0.3483
# Validation time: 2.9036104679107666 seconds
# Completed Epoch 5 of 100 in 31.60 s
# Epoch loss: 3.4465
# Training time: 39.388755798339844 seconds
# Validation error: 1.8458
# Validation time: 3.7882957458496094 seconds
# Completed Epoch 6 of 100 in 43.18 s
# Epoch loss: 4.9798
# Training time: 42.23835277557373 seconds
# Validation error: 1.9916
# Validation time: 4.485505819320679 seconds
# Completed Epoch 7 of 100 in 46.72 s
# Epoch loss: 2.4867
# Training time: 38.134241580963135 seconds
# Validation error: 1.4004
# Validation time: 4.5916290283203125 seconds
# Completed Epoch 8 of 100 in 42.73 s
# Epoch loss: 0.4816
# Training time: 36.91786503791809 seconds
# Validation error: 0.5984
# Validation time: 4.596552610397339 seconds
# Completed Epoch 9 of 100 in 41.51 s
# Epoch loss: 1.0769
# Training time: 33.790695667266846 seconds
# Validation error: 0.3096
# Validation time: 3.8470311164855957 seconds
# Completed Epoch 10 of 100 in 37.64 s
# Epoch loss: 2.9417
# Training time: 37.65514254570007 seconds
# Validation error: 0.9132
# Validation time: 4.08746075630188 seconds
# Completed Epoch 11 of 100 in 41.74 s
# Epoch loss: 3.7774
# Training time: 36.50591206550598 seconds
# Validation error: 0.9552
# Validation time: 4.558565139770508 seconds
# Completed Epoch 12 of 100 in 41.06 s
# Epoch loss: 2.3126
# Training time: 44.290722608566284 seconds
# Validation error: 0.6122
# Validation time: 4.288101673126221 seconds
# Completed Epoch 13 of 100 in 48.58 s
# Epoch loss: 0.9262
# Training time: 39.89321947097778 seconds
# Validation error: 0.3160
# Validation time: 3.9446613788604736 seconds
# Completed Epoch 14 of 100 in 43.84 s
# Epoch loss: 0.6711
# Training time: 39.88268184661865 seconds
# Validation error: 0.8107
# Validation time: 4.459048271179199 seconds
# Completed Epoch 15 of 100 in 44.34 s



# WITH thirty graphs:
# Epoch loss: 7.7060
# Training time: 50.958420753479004 seconds
# Validation error: 0.4459
# Validation time: 11.071645021438599 seconds
# Completed Epoch 1 of 100 in 62.03 s
# /home/rishabh/miniconda3/envs/mgt_py310/lib/python3.10/site-packages/torch/distributed/fsdp/_state_dict_utils.py:768: UserWarning: When using ``NO_SHARD`` for ``ShardingStrategy``, full_state_dict willbe returned.
#   warnings.warn(
# /home/rishabh/miniconda3/envs/mgt_py310/lib/python3.10/site-packages/torch/distributed/fsdp/_state_dict_utils.py:711: UserWarning: When using ``NO_SHARD`` for ``ShardingStrategy``, full_state_dict willbe returned.
#   warnings.warn(
# Epoch loss: 3.9047
# Training time: 67.39437413215637 seconds
# Validation error: 1.0379
# Validation time: 11.16936206817627 seconds
# Completed Epoch 2 of 100 in 78.56 s
# Epoch loss: 0.9591
# Training time: 65.3174819946289 seconds
# Validation error: 0.2581
# Validation time: 11.083319664001465 seconds
# Completed Epoch 3 of 100 in 76.40 s
# Epoch loss: 0.9954
# Training time: 59.84040307998657 seconds
# Validation error: 0.6625
# Validation time: 8.698781490325928 seconds
# Completed Epoch 4 of 100 in 68.54 s
# Epoch loss: 0.9853
# Training time: 60.69777274131775 seconds
# Validation error: 0.2222
# Validation time: 8.866515398025513 seconds
# Completed Epoch 5 of 100 in 69.56 s
# Epoch loss: 0.6190
# Training time: 56.56956124305725 seconds
# Validation error: 0.4193
# Validation time: 7.667185306549072 seconds
# Completed Epoch 6 of 100 in 64.24 s
# Epoch loss: 0.8304
# Training time: 54.826375007629395 seconds
# Validation error: 0.4181
# Validation time: 7.8981382846832275 seconds
# Completed Epoch 7 of 100 in 62.72 s
# Epoch loss: 0.6249
# Training time: 55.62831115722656 seconds
# Validation error: 0.1632
# Validation time: 7.646490097045898 seconds
# Completed Epoch 8 of 100 in 63.27 s
# Epoch loss: 0.6232
# Training time: 54.65222120285034 seconds
# Validation error: 0.3344
# Validation time: 8.010087490081787 seconds
# Completed Epoch 9 of 100 in 62.66 s
# Epoch loss: 0.7625
# Training time: 59.15792894363403 seconds
# Validation error: 0.3030
# Validation time: 7.922102689743042 seconds
# Completed Epoch 10 of 100 in 67.08 s
# Epoch loss: 0.5552
# Training time: 67.45439410209656 seconds
# Validation error: 0.1629
# Validation time: 9.851112127304077 seconds
# Completed Epoch 11 of 100 in 77.31 s
# Epoch loss: 0.5362
# Training time: 58.50663089752197 seconds
# Validation error: 0.2985
# Validation time: 9.510268688201904 seconds
# Completed Epoch 12 of 100 in 68.02 s
# Epoch loss: 0.6126
# Training time: 54.2996723651886 seconds
# Validation error: 0.4203
# Validation time: 10.225694179534912 seconds
# Completed Epoch 13 of 100 in 64.53 s
# Epoch loss: 0.5713
# Training time: 60.03849267959595 seconds
# Validation error: 0.2456
# Validation time: 10.861678838729858 seconds
# Completed Epoch 14 of 100 in 70.90 s
# Epoch loss: 0.5449
# Training time: 58.64361023902893 seconds
# Validation error: 0.1460
# Validation time: 10.238805532455444 seconds
# Completed Epoch 15 of 100 in 68.88 s







# 
# CURRENT BEST
# 




# LIN++
# Epoch loss: 1.8418
# Training time: 9.18 s
# Validation error: 0.9521
# Epoch 1 validation complete
# New best model saved to /home/rishabh/saved_models/lowest.ckpt
# Completed Epoch 1/100 in 11.74 s
# Epoch loss: 1.8144
# Training time: 7.49 s
# Validation error: 0.9456
# Epoch 2 validation complete
# New best model saved to /home/rishabh/saved_models/lowest.ckpt
# Completed Epoch 2/100 in 10.19 s
# /home/rishabh/miniconda3/envs/mgt_py310/lib/python3.10/site-packages/pymatgen/core/structure.py:3090: UserWarning: Issues encountered while parsing CIF: 2 fractional coordinates rounded to ideal values to avoid issues with finite precision.
#   struct = parser.parse_structures(primitive=primitive)[0]
# Epoch loss: 8.6484
# Training time: 9.13 s
# Validation error: 2.0974
# Epoch 3 validation complete
# Completed Epoch 3/100 in 11.58 s
# Epoch loss: 8.6684
# Training time: 8.31 s
# Validation error: 2.0989
# Epoch 4 validation complete
# Completed Epoch 4/100 in 10.85 s
# /home/rishabh/miniconda3/envs/mgt_py310/lib/python3.10/site-packages/pymatgen/core/structure.py:3090: UserWarning: Issues encountered while parsing CIF: 2 fractional coordinates rounded to ideal values to avoid issues with finite precision.
#   struct = parser.parse_structures(primitive=primitive)[0]
# Epoch loss: 2.1189
# Training time: 9.02 s
# Validation error: 0.4138
# Epoch 5 validation complete
# New best model saved to /home/rishabh/saved_models/lowest.ckpt
# Completed Epoch 5/100 in 11.88 s
# Epoch loss: 1.6585
# Training time: 9.03 s
# Validation error: 1.2268
# Epoch 6 validation complete
# Completed Epoch 6/100 in 11.74 s
# /home/rishabh/miniconda3/envs/mgt_py310/lib/python3.10/site-packages/pymatgen/core/structure.py:3090: UserWarning: Issues encountered while parsing CIF: 2 fractional coordinates rounded to ideal values to avoid issues with finite precision.
#   struct = parser.parse_structures(primitive=primitive)[0]
# Epoch loss: 1.6701
# Training time: 9.07 s
# Validation error: 1.1250
# Epoch 7 validation complete
# Completed Epoch 7/100 in 11.76 s
# Epoch loss: 0.7063
# Training time: 9.67 s
# Validation error: 0.2105
# Epoch 8 validation complete
# New best model saved to /home/rishabh/saved_models/lowest.ckpt
# Completed Epoch 8/100 in 12.59 s
# Epoch loss: 0.5470
# Training time: 8.26 s
# Validation error: 0.3113
# Epoch 9 validation complete
# Completed Epoch 9/100 in 10.54 s
# Epoch loss: 0.7523
# Training time: 8.73 s
# Validation error: 0.3818
# Epoch 10 validation complete
# Completed Epoch 10/100 in 11.38 s
# Epoch loss: 0.4914
# Training time: 6.28 s
# Validation error: 0.1548
# Epoch 11 validation complete
# New best model saved to /home/rishabh/saved_models/lowest.ckpt
# Completed Epoch 11/100 in 8.89 s
# Epoch loss: 0.3034
# Training time: 7.50 s
# Validation error: 0.1667
# Epoch 12 validation complete
# Completed Epoch 12/100 in 9.86 s
# Epoch loss: 0.3439
# Training time: 7.95 s
# Validation error: 0.2371
# Epoch 13 validation complete
# Completed Epoch 13/100 in 10.37 s
# Epoch loss: 0.3493
# Training time: 8.80 s
# Validation error: 0.2059
# Epoch 14 validation complete
# Completed Epoch 14/100 in 11.05 s
# Epoch loss: 0.3180
# Training time: 7.49 s
# Validation error: 0.1986
# Epoch 15 validation complete
# Completed Epoch 15/100 in 9.85 s
# Epoch loss: 0.3576
# Training time: 8.22 s
# Validation error: 0.2404
# Epoch 16 validation complete
# Completed Epoch 16/100 in 10.58 s
# Epoch loss: 0.3337
# Training time: 8.47 s
# Validation error: 0.2702
# Epoch 17 validation complete
# Completed Epoch 17/100 in 10.78 s
# Epoch loss: 0.3726
# Training time: 8.23 s
# Validation error: 0.3119
# Epoch 18 validation complete
# Completed Epoch 18/100 in 10.61 s
# Epoch loss: 0.6457
# Training time: 7.81 s
# Validation error: 0.5307
# Epoch 19 validation complete
# Completed Epoch 19/100 in 10.23 s


import torch
import torch.nn as nn
import torch.nn.functional as F
import dgl
import dgl.function as fn
from dgl import DGLGraph
from torch import Tensor
from typing import Union, Tuple

class LowRankLinear(nn.Module):
    def __init__(self, in_features: int, out_features: int, rank_factor: int = 4, bias: bool = True):
        super().__init__()
        if rank_factor <= 0:
            self.layer = nn.Linear(in_features, out_features, bias=bias)
        elif in_features % rank_factor != 0 or out_features % rank_factor != 0:
            print(f"Warning: feature_dims ({in_features}, {out_features}) not divisible by rank_factor ({rank_factor}). Using standard Linear layer.")
            self.layer = nn.Linear(in_features, out_features, bias=bias)
        else:
            rank = in_features // rank_factor
            self.layer = nn.Sequential(
                nn.Linear(in_features, rank, bias=False),
                nn.Linear(rank, out_features, bias=bias)
            )

    def forward(self, x):
        return self.layer(x)

class EdgeGatedGraphConv(nn.Module):
    def __init__(self, feature_dims: int, norm: Union[bool, Tuple[bool, bool]] = True, residual: bool = True, rank_factor: int = 4):
        super().__init__()
        self.residual = residual
        self.rank_factor = rank_factor
        if isinstance(norm, bool):
            norm = (norm, norm)
        self.norm = norm
        self.src_gate = LowRankLinear(feature_dims, feature_dims, rank_factor=rank_factor)
        self.dst_gate = LowRankLinear(feature_dims, feature_dims, rank_factor=rank_factor)
        self.edge_gate = LowRankLinear(feature_dims, feature_dims, rank_factor=rank_factor)
        if norm[0]:
            self.norm_nodes = nn.LayerNorm(feature_dims)
        self.src_update = LowRankLinear(feature_dims, feature_dims, rank_factor=rank_factor)
        self.dst_update = LowRankLinear(feature_dims, feature_dims, rank_factor=rank_factor)
        if norm[1]:
            self.norm_edges = nn.LayerNorm(feature_dims)

    def forward(self, g: dgl.DGLGraph, node_feats: Tensor, edge_feats: Tensor) -> Tuple[Tensor, Tensor]:
        g = g.local_var()
        if self.residual:
            node_feats_residual = node_feats
            edge_feats_residual = edge_feats
        e_src = self.src_gate(node_feats)
        e_dst = self.dst_gate(node_feats)
        e_edge = self.edge_gate(edge_feats)
        g.ndata["e_src"] = e_src
        g.ndata["e_dst"] = e_dst
        g.apply_edges(fn.u_add_v("e_src", "e_dst", "e_nodes"))
        m = g.edata.pop("e_nodes") + e_edge
        g.edata["sigma"] = torch.sigmoid(m)
        g.ndata["Bh"] = self.dst_update(node_feats)
        g.update_all(
            fn.u_mul_e("Bh", "sigma", "m"), fn.sum("m", "sum_sigma_h")
        )
        g.update_all(fn.copy_e("sigma", "m"), fn.sum("m", "sum_sigma"))
        sum_sigma_h = g.ndata.pop("sum_sigma_h")
        sum_sigma = g.ndata.pop("sum_sigma")
        h = sum_sigma_h / (sum_sigma + 1e-6)
        x = self.src_update(node_feats) + h
        if self.norm[0]:
            x = self.norm_nodes(x)
        x = F.silu(x)
        if self.residual:
            x = node_feats_residual + x
        y = m
        if self.norm[1]:
            y = self.norm_edges(y)
        y = F.silu(y)
        if self.residual:
            y = edge_feats_residual + y
        return x, y

    def __repr__(self):
        return f"{self.__class__.__name__}(feature_dims={self.src_gate.layer[0].in_features}, rank_factor={self.rank_factor}, norm={self.norm}, residual={self.residual})"

class ALIGNNLayer(nn.Module):
    def __init__(self, feature_dims: int, edge_norm: Union[bool, Tuple[bool, bool]] = True, node_norm: Union[bool, Tuple[bool, bool]] = True, rank_factor: int = 0):
        super(ALIGNNLayer, self).__init__()
        if isinstance(edge_norm, bool):
            edge_norm = (edge_norm, edge_norm)
        if isinstance(node_norm, bool):
            node_norm = (node_norm, node_norm)
        self.edge_update = EdgeGatedGraphConv(feature_dims=feature_dims, norm=edge_norm)
        self.atom_update = EdgeGatedGraphConv(feature_dims=feature_dims, norm=node_norm)

    def forward(self, g: dgl.DGLGraph, lg: dgl.DGLGraph, x: Tensor, y: Tensor, z: Tensor):
        y, z = self.edge_update(g=lg, node_feats=y, edge_feats=z)
        x, y = self.atom_update(g=g, node_feats=x, edge_feats=y)
        return x, y, z

